<!-- 
- To run server with book data:cd to /WD/week11/bookserver and run node server.js

- 1. Set data to empty with loaded set to false
- 2. Update template to show nothing unless loaded (if condidional in template file)
- 3. Implement a fetch to pull in data and update it
- 4. Can call renderTemplate on data completely loaded
- 5. Wrap fetch in a setInterval (polling API)
-->
<html>
    <head>
        
    </head>
    <body>
        <!--Div for template engine to insert data into-->
        <div id="content">

        </div>
        <script>
            
            class SimpleTemplateEngine{
                constructor(template_url){
                    this.template_url = template_url
                }

                loadTemplate(){
                    // Returns promise (fetch)
                    return fetch(this.template_url)
                    .then(response => response.text())
                    .then(text => {
                        this.template = text;
                    })
                }

                //Parse and insert template into the DOM
                renderTemplate(tag_id, data){
                    const tag = document.getElementById(tag_id);

                    //See more ways of doing this in index.html
                    let output = this.template;
                    
                    //deal with any each loops
                    output = output.replace(/{{#each (\w+)}}([\s\S]*?){{\/each}}/g, (match,arrayName, templateFragment)=>{
                        const listOfThings = data[arrayName];
                        

                        if (!Array.isArray(listOfThings)){
                            return '';
                        }
                        return listOfThings.map(item => this.replaceVariablesInFragment(templateFragment, item)).join('');
                    });

                    //deal with if-else conditions
                    output = output.replace(/{{#if (\w+)}}([\s\S]*?){{else}}([\s\S]*?){{\/if}}/g, (match, condition, ifContent, elseContent) => {
                        return data[condition] ? ifContent : elseContent;
                    })

                    //deal with if-only conditions
                    output = output.replace(/{{#if (\w+)}}([\s\S]*?){{\/if}}/g,(match, condition, ifContent)=>{
                        return data[condition] ? ifContent : ''
                    })

                    //deal with simple variables
                    output = output.replace(/{{(\w+)}}/g,(match, dataField) =>{
                        return data[dataField]
                    } )
                    console.log(output)
                    tag.innerHTML = output;
                }
                
                replaceVariablesInFragment(templateFragment,data){
                    return templateFragment.replace(/{{(\w+)}}/g, (match,dataKey)=>{
                        return data[dataKey]
                    })
                }
            };

            const tEngine = new SimpleTemplateEngine("template4.html")

            //1.Set data to empty with loaded set to false
            let data = {
                loaded: false
            };

            //5. Wrap fetch in a setInterval (polling API)
            setInterval(()=>{
                //3.Implement a fetch to pull in data and update it
                fetch("http://localhost:3000/api/books")
                .then(response => response.json())
                .then(jsonData => {
                    data = {loaded:true,
                            title: "Book List",
                            books: jsonData
                        }
                    // 4. Render template when data is loaded
                    tEngine.renderTemplate('content', data)
                })
            },4000);
            
            tEngine.loadTemplate()
            .then(() =>{
                tEngine.renderTemplate('content', data)
            })
        </script>
    </body>
</html>